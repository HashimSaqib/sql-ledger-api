<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.3;
            margin: 0;
            padding: 15px;
            color: #000;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo img {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 10px;
        }
        
        .company-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .company-address {
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .report-title {
            font-size: 16px;
            font-weight: bold;
            margin: 15px 0 5px 0;
        }
        
        .currency-line {
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .main-table {
            border: none;
        }
        
        .main-table th,
        .main-table td {
            border: none;
            padding: 2px 5px;
            vertical-align: top;
        }
        
        .period-header {
            font-weight: bold;
            text-align: right;
            font-size: 11px;
            padding: 5px;
            border-bottom: 1px solid #000;
        }
        
        .section-header {
            font-weight: bold;
            font-size: 12px;
            padding: 8px 0 4px 0;
            border-bottom: 1px solid #000;
            text-transform: uppercase;
        }
        
        .account-row {
            padding: 1px 0;
        }
        
        .account-label {
            text-align: left;
            padding-left: 0px;
            font-size: 10px;
        }
        
        .account-amount {
            text-align: right;
            font-size: 10px;
            min-width: 80px;
            padding-left: 10px;
        }
        
        .header-account {
            font-weight: bold;
            font-size: 11px;
            margin: 3px 0 2px 0;
        }
        
        .detail-account {
            font-weight: normal;
            margin: 1px 0;
        }
        
        .total-row {
            font-weight: bold;
            font-size: 11px;
            border-top: 1px solid #000;
            padding-top: 3px;
            margin-top: 3px;
        }
        
        .section-total {
            font-weight: bold;
            font-size: 11px;
            margin-top: 5px;
            padding-top: 2px;
            border-top: 1px solid #000;
        }
        
        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }
        .indent-3 { padding-left: 60px; }
        .indent-4 { padding-left: 80px; }
        .indent-5 { padding-left: 100px; }
        
        .spacer-row {
            height: 8px;
        }
        
        .grand-total {
            font-weight: bold;
            font-size: 12px;
            border-top: 2px solid #000;
            border-bottom: 1px solid #000;
            padding: 4px 0;
        }
        
        .number {
            font-family: monospace;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            % if ($logo) {
            <img src="<%= $logo %>">
            % }
        </div>
        <div class="company-name"><%= $company || '' %></div>
        <div class="company-address"><%= $address || '' %></div>
    </div>
    
    
    <div class="report-title center">Bilanz</div>
    <div class="currency-line center">WÃ¤hrung: <%= $currency %></div>
    
    % if ($department) {
    <div>Department: <%= $department %></div>
    % }
    
    % if ($projectnumber) {
    <div>Project Number: <%= $projectnumber %></div>
    % }
    
    <table class="main-table">
        <thead>
            <tr>
                <th style="text-align: left; font-weight: bold; padding: 5px 0;">AKTIVEN</th>
                % for my $period (@$periods) {
                <th class="period-header"><%= $period->{label} %></th>
                % }
            </tr>
        </thead>
        <tbody>
            <%
                sub render_accounts_improved {
                    my ($data, $hierarchy, $periods, $level, $section_name, $heading_level) = @_;
                    $level ||= 0;
                    my $output = '';
                    
                    # Determine max visible level based on heading_level parameter
                    # heading_level=1 means show only level 0, heading_level=2 means levels 0-1, etc.
                    my $max_visible_level = defined($heading_level) && $heading_level ne '' && $heading_level > 0 
                        ? $heading_level - 1 
                        : undef;
                    
                    for my $accno (sort { $a <=> $b } keys %$hierarchy) {
                        my $account = $data->{$accno};
                        next unless $account;
                        
                        my $is_header = $account->{charttype} eq 'H';
                        my $account_level = $account->{level} // $level;
                        
                        # Skip if heading_level filtering is active
                        if (defined($max_visible_level)) {
                            # Skip detail accounts when heading_level is set
                            next if !$is_header;
                            # Skip headings deeper than max visible level
                            next if $account_level > $max_visible_level;
                        }
                        
                        my $indent_class = $level > 0 ? "indent-$level" : "";
                        my $row_class = $is_header ? 'header-account' : 'detail-account';
                        
                        # Apply indentation to both headers and details based on their level
                        # Headers get indentation based on their level
                        # Details get one extra level of indentation under their parent header
                        my $final_indent_class;
                        if ($is_header) {
                            $final_indent_class = $level > 0 ? "indent-$level" : "";
                        } else {
                            $final_indent_class = "indent-" . ($level + 1);
                        }
                        
                        # Determine if we should show amounts for this heading
                        # Show amounts when: it's the deepest visible level OR when it's a detail account
                        my $show_amount = !$is_header;
                        if ($is_header && defined($max_visible_level)) {
                            # For headings in collapsed mode, show amount if this is at max visible level
                            $show_amount = ($account_level == $max_visible_level);
                        }
                        
                        $output .= '<tr class="account-row">';
                        $output .= qq{<td class="account-label $row_class $final_indent_class">};
                        $output .= $account->{label};
                        $output .= '</td>';
                        
                        for my $period (@$periods) {
                            my $amount = '';
                            # Only show amounts for detail accounts (charttype 'A'), not headers (unless collapsed)
                            if ($show_amount && $account->{amounts}{$period->{label}}) {
                                $amount = $account->{amounts}{$period->{label}};
                            }
                            $output .= qq{<td class="account-amount number">$amount</td>};
                        }
                        $output .= '</tr>';
                        
                        # Render children if any (only if not filtered out by heading_level)
                        if (keys %{$account->{children}}) {
                            my $should_show_children = 1;
                            if (defined($max_visible_level) && $account_level >= $max_visible_level) {
                                $should_show_children = 0;
                            }
                            
                            if ($should_show_children) {
                                my %child_hierarchy = map { $_ => 1 } keys %{$account->{children}};
                                $output .= render_accounts_improved($data, \%child_hierarchy, $periods, $level + 1, $section_name, $heading_level);
                            }
                        }
                        
                        # Add total row for header accounts that have children (only when children are visible)
                        if ($is_header && keys %{$account->{children}}) {
                            my $show_section_total = 1;
                            if (defined($max_visible_level) && $account_level >= $max_visible_level) {
                                $show_section_total = 0;
                            }
                            
                            if ($show_section_total) {
                                $output .= '<tr class="section-total">';
                                $output .= qq{<td class="account-label $final_indent_class"><strong>TOTAL } . uc($account->{label}) . '</strong></td>';
                                
                                for my $period (@$periods) {
                                    my $amount = $account->{amounts}{$period->{label}} || '';
                                    $output .= qq{<td class="account-amount number"><strong>$amount</strong></td>};
                                }
                                $output .= '</tr>';
                                
                                # Add spacer row
                                $output .= '<tr class="spacer-row"><td colspan="100%"></td></tr>';
                            }
                        }
                    }
                    return $output;
                }
            %>
            
            <%== render_accounts_improved($assets_data, $assets_hierarchy, $periods, 0, 'ASSETS', $heading_level) %>
            
            <tr class="grand-total">
                <td class="account-label"><strong>TOTAL AKTIVEN</strong></td>
                % for my $period (@$periods) {
                <td class="account-amount number"><strong><%= $net_totals->{assets}{$period->{label}} %></strong></td>
                % }
            </tr>
            
            <tr class="spacer-row"><td colspan="100%">&nbsp;</td></tr>
            
            <!-- Passiven Section -->
            <tr>
                <th style="text-align: left; font-weight: bold; padding: 15px 0 5px 0; border-bottom: 1px solid #000;">PASSIVEN</th>
                % for my $period (@$periods) {
                <th class="period-header"></th>
                % }
            </tr>
            
            <!-- Liabilities Subsection -->
            <tr>
                <td class="section-header">KURZFRISTIGES FREMDKAPITAL</td>
                % for my $period (@$periods) {
                <td></td>
                % }
            </tr>
            
            <%== render_accounts_improved($liabilities_data, $liabilities_hierarchy, $periods, 0, 'LIABILITIES', $heading_level) %>
            
            <tr class="section-total">
                <td class="account-label"><strong>TOTAL KURZFRISTIGES FREMDKAPITAL</strong></td>
                % for my $period (@$periods) {
                <td class="account-amount number"><strong><%= $net_totals->{liabilities}{$period->{label}} %></strong></td>
                % }
            </tr>
            
            <tr class="spacer-row"><td colspan="100%"></td></tr>
            
            <!-- Equity Subsection -->
            <tr>
                <td class="section-header">EIGENKAPITAL</td>
                % for my $period (@$periods) {
                <td></td>
                % }
            </tr>
            
            <%== render_accounts_improved($equity_data, $equity_hierarchy, $periods, 0, 'EQUITY', $heading_level) %>
            
            <!-- Current Earnings Row -->
            <tr class="account-row">
                <td class="account-label detail-account">Current Earnings</td>
                % for my $period (@$periods) {
                <td class="account-amount number"><%= $current_earnings->{$period->{label}} %></td>
                % }
            </tr>
            
            <tr class="section-total">
                <td class="account-label"><strong>TOTAL EIGENKAPITAL</strong></td>
                % for my $period (@$periods) {
                <td class="account-amount number"><strong><%= $net_totals->{total_equity}{$period->{label}} %></strong></td>
                % }
            </tr>
            
            <tr class="spacer-row"><td colspan="100%"></td></tr>
            
            <tr class="grand-total">
                <td class="account-label"><strong>TOTAL PASSIVEN</strong></td>
                % for my $period (@$periods) {
                <td class="account-amount number"><strong><%= $net_totals->{total_liabilities_equity}{$period->{label}} %></strong></td>
                % }
            </tr>
        </tbody>
    </table>
</body>
</html>
