<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 11px;
      line-height: 1.3;
      margin: 0;
      padding: 15px;
      color: #000;
    }
    .header { text-align: center; margin-bottom: 20px; }
    .logo img { max-width: 200px; max-height: 80px; margin-bottom: 10px; }
    .company-name { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
    .company-address { font-size: 12px; margin-bottom: 10px; }
    .report-title { font-size: 16px; font-weight: bold; margin: 15px 0 5px 0; }
    .currency-line { font-size: 12px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; margin: 0; }
    .main-table th, .main-table td { padding: 2px 5px; vertical-align: top; }
    .period-header { font-weight: bold; text-align: right; font-size: 11px; padding: 5px; border-bottom: 1px solid #000; }
    .section-header { font-weight: bold; font-size: 12px; padding: 8px 0 4px 0; border-bottom: 1px solid #000; text-transform: uppercase; }
    .account-label { text-align: left; font-size: 10px; }
    .account-amount { text-align: right; font-size: 10px; min-width: 80px; padding-left: 10px; font-family: monospace; white-space: nowrap; }
    .header-account { font-weight: bold; font-size: 11px; }
    .detail-account { font-weight: normal; }
    .total-row, .section-total { font-weight: bold; font-size: 11px; border-top: 1px solid #000; padding-top: 3px; }
    .indent-1 { padding-left: 20px; } .indent-2 { padding-left: 40px; } .indent-3 { padding-left: 60px; } .indent-4 { padding-left: 80px; } .indent-5 { padding-left: 100px; }
    .spacer-row { height: 8px; }
    .grand-total { font-weight: bold; font-size: 12px; border-top: 2px solid #000; border-bottom: 1px solid #000; padding: 4px 0; }
  </style>
</head>
<body>
<div class="header">
  <div class="logo">
    % if ($logo) {
      <img src="<%= $logo %>">
    % }
  </div>
  <div class="company-name"><%= $company || '' %></div>
  <div class="company-address"><%= $address || '' %></div>
</div>

<div class="report-title center">Gewinn- und Verlustrechnung</div>
<div class="currency-line center">Währung: <%= $currency %></div>

% if ($department) {
<div>Abteilung: <%= $department %></div>
% }

% if ($projectnumber) {
<div>Projektnummer: <%= $projectnumber %></div>
% }

<table class="main-table">
  <thead>
    <tr>
      <th style="text-align: left; font-weight: bold; padding: 5px 0;">ERTRÄGE</th>
      % for my $period (@$periods) {
        <th class="period-header"><%= $period %></th>
      % }
    </tr>
  </thead>
  <tbody>
    <% 
      sub render_accounts {
        my ($data, $hierarchy, $periods, $level, $heading_level) = @_;
        $level ||= 0;
        my $output = '';
        
        # Determine max visible level based on heading_level parameter
        # heading_level=1 means show only level 0, heading_level=2 means levels 0-1, etc.
        my $max_visible_level = defined($heading_level) && $heading_level ne '' && $heading_level > 0 
            ? $heading_level - 1 
            : undef;
        
        for my $accno (sort { $a <=> $b } keys %$hierarchy) {
          my $account = $data->{$accno};
          next unless $account;
          
          my $is_header = $account->{charttype} eq 'H';
          my $account_level = $account->{level} // $level;
          
          # Skip if heading_level filtering is active
          if (defined($max_visible_level)) {
            # Skip detail accounts when heading_level is set
            next if !$is_header;
            # Skip headings deeper than max visible level
            next if $account_level > $max_visible_level;
          }
          
          my $indent_class = $level > 0 ? "indent-$level" : "";
          my $row_class = $is_header ? 'header-account' : 'detail-account';
          my $final_indent = $is_header ? $indent_class : "indent-" . ($level + 1);

          # Determine if we should show amounts for this heading
          # Show amounts when: it's the deepest visible level OR when it's a detail account
          my $show_amount = !$is_header;
          if ($is_header && defined($max_visible_level)) {
            # For headings in collapsed mode, show amount if this is at max visible level
            $show_amount = ($account_level == $max_visible_level);
          }

          $output .= '<tr>';
          $output .= qq{<td class="account-label $row_class $final_indent">$account->{label}</td>};
          for my $p (@$periods) {
            my $amt = $show_amount ? ($account->{amounts}{$p} || '') : '';
            $output .= qq{<td class="account-amount">$amt</td>};
          }
          $output .= '</tr>';

          # Only recurse into children if not filtered out by heading_level
          if ($account->{children}) {
            my $should_show_children = 1;
            if (defined($max_visible_level) && $account_level >= $max_visible_level) {
              $should_show_children = 0;
            }
            
            if ($should_show_children) {
              my %children = map { $_ => 1 } keys %{$account->{children}};
              $output .= render_accounts($data, \%children, $periods, $level + 1, $heading_level);
            }
          }

          # Show section total only when children are visible
          if ($is_header && $account->{children}) {
            my $show_section_total = 1;
            if (defined($max_visible_level) && $account_level >= $max_visible_level) {
              $show_section_total = 0;
            }
            
            if ($show_section_total) {
              $output .= '<tr class="section-total">';
              $output .= qq{<td class="$final_indent"><strong>GESAMT } . uc($account->{label}) . '</strong></td>';
              for my $p (@$periods) {
                my $amt = $account->{amounts}{$p} || '';
                $output .= qq{<td class="account-amount"><strong>$amt</strong></td>};
              }
              $output .= '</tr><tr class="spacer-row"><td colspan="100%"></td></tr>';
            }
          }
        }
        return $output;
      }
    %>

    <%== render_accounts($income_data, $income_hierarchy, $periods, 0, $heading_level) %>

    <tr class="section-total">
      <td class="account-label"><strong>GESAMTERTRÄGE</strong></td>
      % for my $period (@$periods) {
        <td class="account-amount"><strong><%= $formatted_totals->{income}{$period} %></strong></td>
      % }
    </tr>

    <tr class="spacer-row"><td colspan="100%"></td></tr>

    <tr>
      <th style="text-align: left; font-weight: bold; padding: 5px 0;">AUFWENDUNGEN</th>
      % for my $period (@$periods) {
        <th class="period-header"></th>
      % }
    </tr>

    <%== render_accounts($expense_data, $expense_hierarchy, $periods, 0, $heading_level) %>

    <tr class="section-total">
      <td class="account-label"><strong>GESAMTAUFWENDUNGEN</strong></td>
      % for my $period (@$periods) {
        <td class="account-amount"><strong><%= $formatted_totals->{expense}{$period} %></strong></td>
      % }
    </tr>

    <tr class="grand-total">
      <td class="account-label"><strong>NETTOGEWINN</strong></td>
      % for my $period (@$periods) {
        <td class="account-amount"><strong><%= $formatted_totals->{profit}{$period} %></strong></td>
      % }
    </tr>
  </tbody>
</table>
</body>
</html>
